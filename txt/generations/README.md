# 世代早見表 実装要件

## 概要
Notionで管理していた人物データベース（791件）を個人サイト（Neocities）に移行し、世代早見表として表示する。

## データ移行

### 現状
- Notion データベースから出力した CSV ファイル（791行）
- 列構成: 名前, Text（空欄）, タグ, 年齢, 死没, 生誕
- タグ列には国名と「詳細不明」が混在

### 移行後のデータ形式
- **JSON形式**を採用
- ファイル名: `data.json`
- Notionから完全に独立し、JSONを直接編集する運用

### JSON データ構造
```json
[
  {
    "name": "井筒俊彦",
    "countries": ["日本"],
    "birth": {
      "date": "1914-05-04",
      "uncertain": false
    },
    "death": {
      "date": "1993-01-07",
      "uncertain": false
    }
  },
  {
    "name": "西尾維新",
    "countries": ["日本"],
    "birth": {
      "date": "1981-01-01",
      "uncertain": true
    },
    "death": null
  }
]
```

### データ項目仕様
- `name`: 人物名（文字列）
- `countries`: 出生国・活動国（文字列の配列、複数可）
- `birth`: 生誕情報（オブジェクト）
  - `date`: 日付（ISO 8601形式: YYYY-MM-DD）
  - `uncertain`: 詳細不明フラグ（真偽値）
    - `true`: 年のみ確定、月日は仮の01-01
    - `false`: 年月日すべて確定
- `death`: 死没情報（オブジェクトまたはnull）
  - 生存者の場合: `null`
  - 死没者の場合: birthと同じ構造

### 詳細不明の扱い
- 「年のみ確定、月日不明」のケースのみ存在
- 「年月確定、日不明」のケースは現状なし
- 詳細不明の場合、月日を `01-01` として記録し `uncertain: true` フラグを立てる

## 表示機能

### 基本表示
- HTMLテーブルで一覧表示
- 表示列:
  - 名前
  - 国（複数国の場合はカンマ区切り）
  - 生誕年月日
  - 死没年月日
  - 年齢（JavaScriptで自動計算）

### 年齢計算
- 生存者: 現在日時からの年齢
- 死没者: 死没日時点での年齢
- 詳細不明の場合も01-01として計算（精度は低いが一貫性を保つ）

### 日付表示
- 詳細不明フラグが立っている場合: 「1981年（詳細不明）」のように表示
- 確定している場合: 「1981年1月1日」のように表示

## ソート機能

### 実装するソート
- 生誕年月日（昇順・降順）
- 死没年月日（昇順・降順）
- 名前（昇順・降順）
- 年齢（昇順・降順）
- 国（昇順・降順）

### ソート時の詳細不明データの扱い
- 詳細不明（01-01）は「その年の最初」として扱う
- 同じ年に詳細不明の人物が複数いる場合は名前でソート

### ソート操作
- テーブルヘッダーをクリックして昇順・降順を切り替え
- ソート状態を視覚的に表示（矢印アイコン）

## フィルタリング機能（発展的機能）

### 国別フィルタリング（実装済み）

**基本機能:**
- ドロップダウンメニューから国を選択
- 複数の国を同時選択可能（OR検索）
- 国名の後ろに該当人数を表示（例：「日本 (650)」）
- 人数の多い順に自動ソート

**選択方法:**
1. 「国を選択」ドロップダウンから選択
2. テーブル内の国名タグを直接クリック

**選択状態の管理:**
- 選択中の国はタグとして表示
- 各タグの×ボタンで個別削除
- 「すべてクリア」ボタンで一括削除

**複数国タグの扱い:**
- 「日本」「アメリカ」両方を持つ人物は、どちらかの国でフィルタリングした際に表示される
- OR検索のみ対応（AND検索は将来的に必要に応じて実装）

### 年代フィルタリング（実装済み）

**プリセット選択:**
- ドロップダウンメニューから世代・年代を選択
- **世代セクション**: 戦前世代、団塊の世代、就職氷河期世代、ゆとり世代、Z世代、おたく第一世代、おたく第二世代など
- **年代セクション**: 1900年代生まれ〜2020年代生まれ（10年刻み）

**手動入力:**
- 開始年と終了年を個別に入力可能
- Enterキーまたはフォーカスアウトで適用
- 入力中は背景色が変わり「未確定」状態を表示
- 開始年のみ: その年以降
- 終了年のみ: その年以前
- 両方指定: その範囲内
- 両方空欄: 制限なし

**カスタム表示:**
- プリセット選択時、入力フィールドに値が自動反映
- 入力フィールドを手動編集すると、プリセットと一致するかチェック
- 一致しない場合「カスタム (1985〜1995)」のように表示

**参考範囲表示:**
- 「前後5年を参考表示」チェックボックスでオン・オフ可能（デフォルト: ON）
- 設定範囲の前後5年を薄く表示（不透明度0.5 + 薄いグレー背景）
- 例: 新人類世代 (1961〜1970) 選択時
  - メイン範囲: 1961〜1970年生まれ（通常表示）
  - 参考範囲: 1956〜1960年、1971〜1975年生まれ（薄く表示）
- 開始年がnullの場合（例：戦前世代 〜1945）、前5年は表示しない
- 終了年がnullの場合、後5年は表示しない
- 参考範囲もソート対象に含まれる
- 参考範囲も国フィルターなど他のフィルターの対象

**統計表示:**
- 「表示中: 150件（参考: 50件）/ 791件」のように内訳を表示
- 参考範囲がない場合は「（参考: X件）」部分を非表示

**世代定義のカスタマイズ:**
- `script.js` の `yearPresets` オブジェクトを編集することで、世代の追加・変更が可能
- 今後、調査に基づいて世代定義を更新予定

### 状態フィルター（実装済み）

**フィルタリング条件:**
- **すべて**: 存命・死没を問わずすべて表示（デフォルト）
- **存命のみ**: 現在存命の人物のみ表示
- **死没のみ**: すでに死没した人物のみ表示

**他のフィルターとの併用:**
- 国フィルター、年代フィルター、特定日付フィルターと組み合わせて使用可能
- 例: 「日本 AND 1980年代生まれ AND 存命のみ」

### 特定日付フィルター（実装済み）

**概要:**
映画や歴史的出来事の時代背景を理解するための機能。特定の過去の日付を指定すると、その時点で存命だった人物のみを表示し、当時の年齢を表示する。

**入力形式:**
- **年のみ**: `2001` → 2001年1月1日として解釈
- **年月**: `2001-09` → 2001年9月1日として解釈
- **年月日**: `2001-09-11` → 2001年9月11日として解釈

**バリデーション:**
- 月の範囲チェック: `2001-13` → 「月は1-12の範囲で入力してください」
- 存在しない日付: `2001-02-30` → 「2001年2月30日は存在しません」
- 未来の日付: `3000` → 「未来の日付は指定できません」
- 形式エラー: `abcd` → 「正しい形式で入力してください」

**表示対象:**
- 指定日時点で存命だった人物のみ
  - 生誕日 ≦ 指定日
  - かつ（死没日 = null OR 死没日 ≧ 指定日）

**年齢表示:**
- **通常ケース**: 指定日時点の年齢を正確に計算
  - 例: 1925年5月15日生まれ → 1968年時点で「43歳」
- **詳細不明（年のみ指定）**: 
  - 例: `2001` 入力 → 「43歳前後」
  - 注釈: ※ 生年月日詳細不明のため推定
- **詳細不明（年月日指定）**: 
  - 例: `2001-09-11` 入力 → 「42-43歳」
  - 注釈: ※ 誕生日不明のため幅を持った表示
  - （誕生日が1月1日〜12月31日のどこかにあるため、誕生日前後で1歳差）

**状態表示:**
- 年のみ: 「2001年(年初)時点の年齢を表示中」
- 年月: 「2001年9月初旬時点の年齢を表示中」
- 年月日: 「2001年9月11日時点の年齢を表示中」

**統計表示:**
- 「表示中: 320件 / 791件（1968年時点で存命）」のように補足情報を表示

**モード切り替え:**
- 特定日付フィルターを適用すると、自動的に「実年齢」モードに切り替わる
- 解除すると通常の表示に戻る

**使用例:**
- `1968` → 1968年を舞台にした映画を見るとき、登場人物のモデルとなった人物が当時何歳だったかを確認
- `2001-09-11` → 同時多発テロ事件の日に、著名人たちが何歳だったかを確認
- `1945-08-15` → 終戦の日に、各人物が何歳だったかを確認

### 複合フィルタリング
- 国フィルター、年代フィルター、状態フィルター、特定日付フィルターをすべて組み合わせて使用可能
- 例: 「日本 AND 1980年代生まれ」
- 例: 「1968年時点で存命 AND アメリカ」
- すべてのフィルター条件を満たす人物のみ表示

### 将来的な拡張
- 名前検索機能
- ~~状態フィルター（存命/死没）~~ → 実装済み（Phase 2）
- より複雑な条件（年代 OR 条件など）
- URLパラメータでのフィルター状態の保存・共有
- ~~特定日付での年齢表示~~ → 実装済み（Phase 3）

## 技術スタック

### 基本方針
- シンプルで軽量な実装
- バニラJavaScript使用（外部ライブラリ最小限）
- 既存の個人サイトのスタイルに準拠

### ファイル構成
```
generations/
├── README.md                  # このファイル（実装要件・仕様書）
├── data.json                  # データファイル（約1,200名の人物データ）
├── generations-timeline.html  # メインページ
├── style.css                  # スタイル
├── script.js                  # ロジック
└── editor/                    # データ編集ツール
    ├── editor.html            # 編集ツールのメインページ
    ├── editor.css             # 編集ツールのスタイル
    └── editor.js              # 編集ツールのロジック
```

### 主要処理
1. JSONファイルの読み込み（fetch API）
2. データのパース
3. テーブルの動的生成
4. ソート機能の実装
5. 年齢計算処理

## データ更新運用

### データ編集ツール（実装済み）
- **場所**: `generations/editor/` ディレクトリ
- **機能**: 
  - ブラウザ上で `data.json` を直接編集可能
  - 人物の追加・編集・削除
  - リアルタイムプレビュー
  - JSON構文エラーの自動チェック
  - 日付のバリデーション
  - ファイルの読み込み・保存機能
- **使用方法**: `editor/editor.html` をブラウザで開く

### 手動編集（代替手段）
- VS Code等のテキストエディタで `data.json` を直接編集
- JSON構文バリデーションはエディタの拡張機能を利用
- 編集後、Neocitiesにアップロード

### JSON編集時の注意点
1. **構文エラーに注意**: カンマ、括弧、引用符の対応を確認
2. **日付形式**: `YYYY-MM-DD` 形式を厳守
3. **null値**: 死没情報がない場合は `"death": null`
4. **配列**: 国は必ず配列形式 `["日本"]`
5. **uncertainフラグ**: 詳細不明の場合のみ `true`

## 実装の段階

### Phase 1: 基本実装（完了）
1. ✅ CSV→JSON変換ツールの作成
2. ✅ JSONデータの読み込みと表示
3. ✅ ソート機能の実装
4. ✅ 年齢自動計算
5. ✅ 詳細不明の表示対応

### Phase 2: フィルタリング機能（完了）
1. ✅ 国別フィルタリング（複数選択、OR検索）
2. ✅ 年代フィルタリング（プリセット + 手動入力）
3. ✅ 参考範囲表示（前後5年を薄く表示）
4. ✅ テーブル内の国名クリックでフィルタリング
5. ✅ 状態フィルター（存命/死没）

### Phase 3: 特定日付表示機能（完了）
1. ✅ 特定の日付時点での年齢表示
2. ✅ 複数の入力形式対応（年/年月/年月日）
3. ✅ バリデーション機能
4. ✅ 詳細不明データの適切な表示
5. ✅ 自動的な実年齢モード切り替え

### Phase 4: 今後の実装
1. 検索機能（名前検索）
2. ~~データ編集ツール（必要に応じて）~~ → 完了（editor/）
3. URLパラメータでのフィルター状態の保存・共有

## 実装詳細

### HTML (index.html)
- 既存サイトの構造に準拠
- パンくずナビゲーション: `100%health / txt / 世代早見表`
- テーブルはJavaScriptで動的に生成
- ローディング表示対応
- フィルターセクション:
  - 国別フィルター（ドロップダウン + 選択タグ表示）
  - 年代フィルター（プリセットドロップダウン + 手動入力フィールド）
  - 参考範囲表示のチェックボックス
  - 状態フィルター（ラジオボタン: すべて/存命のみ/死没のみ）
  - 特定日付フィルター（テキスト入力 + 表示/解除ボタン）
  - 統計情報表示

### JavaScript (script.js)
- **データ読み込み**: `fetch()` でdata.jsonを取得
- **年齢計算**: 生誕日と死没日（または現在日）から計算
- **特定日付年齢計算**: 指定日時点での年齢を計算（詳細不明データに対応）
- **日付フォーマット**: 日本語形式で表示、詳細不明は年のみ表示
- **ソート処理**: 各列でのソートをサポート、ソート状態を保持
- **国別フィルタリング**: 
  - 国リストを自動抽出して人数カウント
  - 複数選択（OR検索）
  - ドロップダウンメニューとテーブル内クリックの両方に対応
- **年代フィルタリング**:
  - プリセット定義（世代・年代）
  - 手動入力対応（Enter / フォーカスアウトで適用）
  - カスタム範囲の検出と表示
  - 参考範囲の計算と表示
- **状態フィルタリング**: 存命/死没/すべて の切り替え
- **特定日付フィルタリング**:
  - 入力パース（年/年月/年月日）
  - バリデーション（月範囲、存在しない日付、未来日付）
  - 指定日時点で存命の人物のみ表示
  - 詳細不明データの適切な年齢表示
- **複合フィルタリング**: 国 + 年代 + 状態 + 特定日付 の組み合わせ
- **イベント処理**: ヘッダークリックでソート、ドロップダウン操作、チェックボックス変更など

### CSS (style.css)
- 既存の `1column.css` をベースに使用
- フィルターセクションのスタイル:
  - ドロップダウンメニュー（セクション分け対応）
  - 選択タグ表示
  - 年代入力フィールド（未確定状態の表示）
  - チェックボックス
  - ラジオボタン
  - 特定日付入力フィールド
  - エラーメッセージ・状態メッセージ表示
- テーブル専用スタイル:
  - ソートインジケーター（矢印）の表示
  - 国名タグのクリック可能スタイル
  - 参考範囲行のスタイル（不透明度 + 背景色）
  - 年齢モード切り替えボタン
- レスポンシブ対応（768px、576pxでブレークポイント）
- ホバーエフェクト

### データ構造
**filteredData オブジェクト:**
```javascript
{
  main: [...],      // メイン範囲の人物
  reference: [...]  // 参考範囲の人物（前後5年）
}
```

**yearPresets オブジェクト:**
```javascript
{
  generations: [
    { name: '戦前世代', start: null, end: 1945 },
    { name: '団塊の世代', start: 1947, end: 1949 },
    // ...
  ],
  decades: [
    { name: '1900年代生まれ', start: 1900, end: 1909 },
    // ...
  ]
}
```

**historicalDate オブジェクト:**
```javascript
{
  date: null,              // Date オブジェクト
  inputGranularity: null,  // 'year' / 'month' / 'day'
  inputString: null,       // 元の入力文字列（表示用）
  year: null,              // 年
  month: null,             // 月
  day: null                // 日
}
```

## 注意事項
- Neocitiesは静的ホスティングのため、サーバーサイド処理は不可
- すべての処理はクライアントサイド（ブラウザ）で完結
- データ件数（791件）は十分に軽量なため、パフォーマンス問題は想定されない

## データ統計
- 総人物数: 約1,200名（2025年11月時点）
- 多様な分野の著名人を収録（文学、哲学、芸術、政治、科学、エンターテインメント等）
- 生年範囲: 15世紀〜21世紀

## 使用方法

### 基本操作
1. **ソート**: テーブルのヘッダー（名前、国、生誕年月日、死没年月日、年齢）をクリック
2. **国別フィルタリング**: 
   - 「国を選択」ドロップダウンから選択、または
   - テーブル内の国名タグをクリック
3. **年代フィルタリング**:
   - 「プリセットを選択」から世代・年代を選択、または
   - 開始年・終了年を直接入力
4. **状態フィルタリング**: 
   - すべて/存命のみ/死没のみ をラジオボタンで選択
5. **特定日付フィルタリング**:
   - 日付入力欄に年（例: 1968）、年月（例: 2001-09）、または年月日（例: 2001-09-11）を入力
   - [表示]ボタンをクリック、またはEnterキーで適用
   - [解除]ボタンで通常表示に戻る
6. **参考範囲表示**: 「前後5年を参考表示」チェックボックスでオン・オフ
7. **年齢モード切り替え**: 年齢列のボタンをクリックして「実年齢」と「経過年数」を切り替え
8. **フィルタークリア**: 各フィルターの「クリア」ボタン、または選択タグの×ボタン

### 活用例
- **世代研究**: 「1980年代生まれ」を選択して、その世代の著名人を一覧
- **国別比較**: 「日本」と「アメリカ」を選択して比較
- **複合検索**: 「日本」+「就職氷河期世代」で該当する人物を抽出
- **参考表示**: 世代の境界を理解するために前後5年を薄く表示
- **時代考察**: 「1968」を入力して、1968年を舞台にした映画や出来事の時代背景を理解
- **歴史的瞬間**: 「2001-09-11」を入力して、同時多発テロ事件の日に各人物が何歳だったかを確認
- **存命者のみ**: 「存命のみ」を選択して、現在活動中の人物のみ表示

## トラブルシューティング

### データが表示されない
- ブラウザのコンソールでエラーを確認
- `data.json` が正しく配置されているか確認
- ファイルパスが正しいか確認

### フィルターが動作しない
- ブラウザのキャッシュをクリア
- JavaScriptが有効になっているか確認

### 特定日付のエラーメッセージが表示される
- 入力形式を確認（YYYY / YYYY-MM / YYYY-MM-DD）
- 月は1-12の範囲内か確認
- 存在する日付か確認（例: 2月は28日または29日まで）
- 未来の日付を入力していないか確認

### 表示が崩れる
- ブラウザの互換性を確認（モダンブラウザ推奨）
- CSSファイルが正しく読み込まれているか確認

### 年齢表示がおかしい
- 年齢モード（実年齢/経過年数）を確認
- 特定日付フィルターが有効な場合、指定日時点の年齢が表示される
- 詳細不明の場合、「前後」や「XX-YY歳」と表示される（仕様通り）