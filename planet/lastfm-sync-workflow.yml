# Last.fmè‡ªå‹•åŒæœŸ - GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ .github/workflows/lastfm-sync.yml ã¨ã—ã¦é…ç½®ã—ã¦ãã ã•ã„

name: Last.fm Scrobbles Sync

on:
  schedule:
    # 1æ™‚é–“ã”ã¨ã«å®Ÿè¡Œï¼ˆæ¯Žæ™‚0åˆ†ï¼‰
    - cron: '0 * * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  sync-lastfm:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 2. Last.fm APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      - name: Fetch Last.fm data
        env:
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          LASTFM_USERNAME: ${{ secrets.LASTFM_USERNAME }}
        run: |
          # Last.fm APIã‚’å‘¼ã³å‡ºã—ã¦JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆï¼ˆ50ä»¶å–å¾—ï¼‰
          curl -s "https://ws.audioscrobbler.com/2.0/?method=user.getRecentTracks&user=${LASTFM_USERNAME}&api_key=${LASTFM_API_KEY}&format=json&limit=50&extended=1" \
            -o lastfm-data.json
          
          # APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæ­£å¸¸ã‹ãƒã‚§ãƒƒã‚¯
          if ! jq -e '.recenttracks' lastfm-data.json > /dev/null; then
            echo "Error: Invalid Last.fm API response"
            echo "Response content:"
            cat lastfm-data.json
            exit 1
          fi
          
          echo "âœ… Last.fm data fetched successfully"
          echo "Track count: $(jq '.recenttracks.track | length' lastfm-data.json)"
      
      # 3. ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼ãƒ»æ•´å½¢
      - name: Validate and format data
        run: |
          # JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã‚’ãƒã‚§ãƒƒã‚¯
          FILE_SIZE=$(stat -c%s lastfm-data.json)
          echo "Generated file size: ${FILE_SIZE} bytes"
          
          # æœ€å°ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ100ãƒã‚¤ãƒˆæœªæº€ã¯ã‚¨ãƒ©ãƒ¼ï¼‰
          if [ $FILE_SIZE -lt 100 ]; then
            echo "Error: Generated file is too small"
            exit 1
          fi
          
          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          echo "Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > lastfm-sync-status.txt
          echo "File size: ${FILE_SIZE} bytes" >> lastfm-sync-status.txt
          
          echo "âœ… Data validation completed"
      
      # 4. Neocitiesã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload to Neocities
        env:
          NEOCITIES_API_KEY: ${{ secrets.NEOCITIES_API_KEY }}
          NEOCITIES_SITENAME: ${{ secrets.NEOCITIES_SITENAME }}
        run: |
          # Neocities APIã‚’ä½¿ã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          echo "Uploading to Neocities..."
          
          # lastfm-data.jsonã‚’/planet/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          UPLOAD_RESULT=$(curl -s -X POST \
            -H "Authorization: Bearer ${NEOCITIES_API_KEY}" \
            -F "planet/lastfm-data.json=@lastfm-data.json" \
            "https://neocities.org/api/upload")
          
          echo "Upload result: $UPLOAD_RESULT"
          
          # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæžœã‚’ãƒã‚§ãƒƒã‚¯
          if echo "$UPLOAD_RESULT" | jq -e '.result == "success"' > /dev/null; then
            echo "âœ… Successfully uploaded to Neocities"
          else
            echo "âŒ Upload failed"
            echo "$UPLOAD_RESULT"
            exit 1
          fi
          
          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          curl -s -X POST \
            -H "Authorization: Bearer ${NEOCITIES_API_KEY}" \
            -F "lastfm-sync-status.txt=@lastfm-sync-status.txt" \
            "https://neocities.org/api/upload" > /dev/null
      
      # 5. æˆåŠŸæ™‚ã®é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: Success notification
        if: success()
        run: |
          echo "ðŸŽµ Last.fm sync completed successfully at $(date)"
          echo "Next sync will run in 30 minutes"
      
      # 6. ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
      - name: Error handling
        if: failure()
        run: |
          echo "âŒ Last.fm sync failed at $(date)"
          echo "Please check the logs and your API keys"
          
          # ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "Sync failed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > lastfm-error.txt
          echo "Check GitHub Actions logs for details" >> lastfm-error.txt
          
          # ã‚¨ãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Neocitiesã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          if [ -n "$NEOCITIES_API_KEY" ]; then
            curl -s -X POST \
              -H "Authorization: Bearer ${NEOCITIES_API_KEY}" \
              -F "lastfm-error.txt=@lastfm-error.txt" \
              "https://neocities.org/api/upload" > /dev/null || true
          fi
